<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>荒川流域 水神碑・水神祠調査地図 (deck.gl 3D版)</title>

    <!-- MapLibre GL JS (ベースマップ用) -->
    <script src='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css' rel='stylesheet' />

    <!-- deck.gl -->
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>

    <!-- PMTiles -->
    <script src="https://unpkg.com/pmtiles@3.0.3/dist/pmtiles.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* コントロールパネル */
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1;
        }

        .control-panel h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: bold;
        }

        .control-group input[type="range"] {
            width: 100%;
        }

        .value-display {
            color: #4CAF50;
            font-weight: bold;
        }

        .checkbox-group {
            margin: 8px 0;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .checkbox-group label {
            font-weight: normal;
            cursor: pointer;
        }

        /* 凡例 */
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: none;
            z-index: 1;
        }

        .legend.show {
            display: block;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .legend-item {
            margin: 4px 0;
            display: flex;
            align-items: center;
        }

        .legend-color {
            display: inline-block;
            width: 20px;
            height: 14px;
            margin-right: 8px;
            border: 1px solid #333;
        }

        /* ローディング */
        .loading {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        /* ズームレベル表示 */
        .zoom-level {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="loading" class="loading">地図を読み込み中...</div>

    <div class="zoom-level" id="zoom-level">ズーム: 11</div>

    <div class="legend" id="hazard-legend">
        <div class="legend-title">浸水深レベル</div>
        <div class="legend-item">
            <span class="legend-color" style="background:#ffffcc;"></span>
            <span>レベル1: 0.5m未満</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background:#ffeda0;"></span>
            <span>レベル2: 0.5-3.0m</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background:#feb24c;"></span>
            <span>レベル3: 3.0-5.0m</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background:#ff6b6b;"></span>
            <span>レベル4: 5.0-10.0m</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background:#bd0026;"></span>
            <span>レベル5: 10.0m以上</span>
        </div>
    </div>

    <div class="control-panel">
        <h3>3D地形設定</h3>

        <div class="control-group">
            <label>地形の高さ倍率: <span id="exaggeration-val" class="value-display">2.0</span></label>
            <input type="range" id="exaggeration-slider" min="0" max="5" step="0.1" value="2.0">
        </div>

        <div class="control-group">
            <label>視点の傾き: <span id="pitch-val" class="value-display">45</span>°</label>
            <input type="range" id="pitch-slider" min="0" max="85" step="5" value="45">
        </div>

        <h3 style="margin-top: 20px;">レイヤー表示</h3>

        <div class="checkbox-group">
            <input type="checkbox" id="layer-3d" onchange="toggle3DTerrain(this.checked)">
            <label for="layer-3d">3D地形表示</label>
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="layer-hazard" onchange="toggleHazard(this.checked)">
            <label for="layer-hazard">浸水想定区域(103河川)</label>
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="layer-monuments" checked onchange="toggleMonuments(this.checked)">
            <label for="layer-monuments">水神碑・水神祠</label>
        </div>
    </div>

    <script>
        const {DeckGL, TerrainLayer, ScatterplotLayer, MVTLayer} = deck;

        // PMTiles プロトコル登録
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        // グローバル変数
        let deckgl;
        let monumentsData = [];
        let showTerrain = false;
        let showHazard = false;
        let showMonuments = true;
        let exaggeration = 2.0;
        let pitch = 45;
        let pmtilesUrl = 'https://pub-6f7d915a556b4c2aab93d0ad18fc694f.r2.dev/hazard_rivers_z9-15.pmtiles';
        let currentViewState = null;

        // 初期ビューステート
        const INITIAL_VIEW_STATE = {
            longitude: 139.404210,
            latitude: 35.939096,
            zoom: 11,
            pitch: 45,
            bearing: 0
        };

        // 色設定
        const MONUMENT_COLORS = {
            water: [0, 0, 255],      // 青
            dragon: [0, 128, 0],     // 緑
            benten: [255, 140, 0],   // オレンジ
            other: [0, 100, 0]       // 濃い緑
        };

        // Terrarium DEMレイヤー（動作確認用）
        function createTerrainLayer() {
            if (!showTerrain) return null;

            console.log('地形レイヤー生成: exaggeration =', exaggeration);

            return new TerrainLayer({
                id: 'terrain',
                minZoom: 0,
                maxZoom: 15,
                elevationDecoder: {
                    rScaler: 256,
                    gScaler: 1,
                    bScaler: 1 / 256,
                    offset: -32768
                },
                elevationData: 'https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png',
                texture: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                wireframe: false,
                color: [255, 255, 255],
                material: {
                    diffuse: 0.8,
                    ambient: 0.3,
                    shininess: 32
                },
                elevationScale: exaggeration
            });
        }

        // 石碑マーカーレイヤー
        function createMonumentsLayer() {
            console.log('createMonumentsLayer呼び出し: showMonuments=', showMonuments, 'データ数=', monumentsData.length);

            if (!showMonuments) {
                console.log('石碑表示がOFF');
                return null;
            }

            if (monumentsData.length === 0) {
                console.log('石碑データが空');
                return null;
            }

            console.log('石碑レイヤーを生成中...');
            return new ScatterplotLayer({
                id: 'monuments',
                data: monumentsData,
                pickable: true,
                opacity: 0.9,
                stroked: true,
                filled: true,
                radiusScale: 6,
                radiusMinPixels: 8,
                radiusMaxPixels: 100,
                lineWidthMinPixels: 2,
                billboard: true,  // 常にカメラに向かって表示（潰れない）
                getPosition: d => [parseFloat(d.lon), parseFloat(d.lat), 500],  // 地面から500m浮かせる
                getRadius: d => 100,
                getFillColor: d => MONUMENT_COLORS[d.type] || [128, 128, 128],
                getLineColor: [0, 0, 0],
                onClick: ({object}) => {
                    if (object) {
                        alert(`${object.name || ''}\n建立年: ${object.year || ''}\n所在地: ${object.address || ''}`);
                    }
                }
            });
        }

        // ハザードマップレイヤー（MVT）
        function createHazardLayer() {
            if (!showHazard) return null;

            // deck.glではPMTilesを直接扱えないため、
            // MVT形式で提供されているタイルサーバーが必要
            // 現在はプレースホルダー（今後実装予定）
            console.log('ハザードマップレイヤーは現在開発中です');
            return null;
        }

        // レイヤーを更新
        function updateLayers() {
            const terrainLayer = createTerrainLayer();
            const monumentsLayer = createMonumentsLayer();
            const hazardLayer = createHazardLayer();

            console.log('=== レイヤー更新 ===');
            console.log('showTerrain:', showTerrain);
            console.log('exaggeration:', exaggeration);
            console.log('- Terrain:', terrainLayer ? 'あり' : 'なし');
            console.log('- Monuments:', monumentsLayer ? 'あり' : 'なし', monumentsData.length, '件');
            console.log('- Hazard:', hazardLayer ? 'あり' : 'なし');

            const layers = [
                terrainLayer,
                monumentsLayer,
                hazardLayer
            ].filter(layer => layer !== null);

            console.log('有効レイヤー数:', layers.length);

            // レイヤー配列を新しく作成して設定（強制更新）
            if (deckgl) {
                deckgl.setProps({
                    layers: [...layers]  // 新しい配列として設定
                });
            }
        }

        // deck.gl初期化
        function initDeckGL() {
            currentViewState = {...INITIAL_VIEW_STATE};

            deckgl = new DeckGL({
                container: 'map',
                mapStyle: 'https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/std.json',
                initialViewState: currentViewState,
                controller: {
                    maxPitch: 85,
                    inertia: true
                },
                layers: [],
                onViewStateChange: ({viewState}) => {
                    currentViewState = viewState;
                    document.getElementById('zoom-level').textContent = `ズーム: ${viewState.zoom.toFixed(1)}`;
                    return viewState;
                }
            });

            // 初期レイヤーを設定
            updateLayers();

            console.log('deck.gl初期化完了');
        }

        // 石碑データの読み込み
        async function loadMonuments() {
            try {
                console.log('石碑データの読み込み開始...');
                const response = await fetch('restart.csv');
                console.log('CSVファイル取得完了');
                const csvText = await response.text();
                console.log('CSVテキスト長:', csvText.length);

                Papa.parse(csvText, {
                    header: true,
                    complete: (results) => {
                        console.log('パース結果:', results.data.length, '行');
                        monumentsData = results.data.filter(row => row.lat && row.lon);
                        console.log('フィルター後:', monumentsData.length, '件');
                        console.log('サンプルデータ:', monumentsData[0]);
                        updateLayers();
                        console.log('レイヤー更新完了');
                    }
                });
            } catch (error) {
                console.error('石碑データの読み込みエラー:', error);
            }
        }

        // 3D地形表示切り替え
        function toggle3DTerrain(enabled) {
            showTerrain = enabled;

            console.log('3D地形表示切り替え:', enabled);

            // 地図全体を再初期化して、ベースマップの表示/非表示を切り替え
            if (deckgl && deckgl._deck) {
                deckgl._deck.finalize();
            }

            const emptyStyle = {
                version: 8,
                sources: {},
                layers: []
            };

            deckgl = new DeckGL({
                container: 'map',
                // 3D地形ON時は空のスタイル、OFF時は標準地図
                mapStyle: enabled ? emptyStyle : 'https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/std.json',
                initialViewState: currentViewState || INITIAL_VIEW_STATE,
                controller: {
                    maxPitch: 85,
                    inertia: true
                },
                layers: [],
                onViewStateChange: ({viewState}) => {
                    currentViewState = viewState;
                    document.getElementById('zoom-level').textContent = `ズーム: ${viewState.zoom.toFixed(1)}`;
                    return viewState;
                }
            });

            // レイヤーを更新
            setTimeout(() => {
                updateLayers();
            }, 50);
        }

        // ハザードマップ切り替え
        function toggleHazard(enabled) {
            showHazard = enabled;
            const legend = document.getElementById('hazard-legend');
            if (enabled) {
                legend.classList.add('show');
            } else {
                legend.classList.remove('show');
            }
            updateLayers();
        }

        // 石碑マーカー切り替え
        function toggleMonuments(enabled) {
            showMonuments = enabled;
            updateLayers();
        }

        // 地形の高さ倍率変更
        document.getElementById('exaggeration-slider').addEventListener('input', (e) => {
            exaggeration = parseFloat(e.target.value);
            document.getElementById('exaggeration-val').textContent = exaggeration.toFixed(1);
            console.log('スライダー変更: exaggeration =', exaggeration);
            // 地形が表示されている場合のみレイヤーを更新
            if (showTerrain) {
                updateLayers();
            }
        });

        // 視点の傾き変更
        document.getElementById('pitch-slider').addEventListener('input', (e) => {
            pitch = parseInt(e.target.value);
            document.getElementById('pitch-val').textContent = pitch;

            if (currentViewState) {
                deckgl.setProps({
                    initialViewState: {
                        ...currentViewState,
                        pitch: pitch
                    }
                });
            }
        });

        // 初期化
        window.addEventListener('load', async () => {
            initDeckGL();
            await loadMonuments();
            document.getElementById('loading').style.display = 'none';
        });
    </script>
</body>
</html>
