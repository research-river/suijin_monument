<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>3D洪水浸水想定区域マップ - deck.gl版</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 350px;
            z-index: 1;
        }
        #controls h2 {
            margin-top: 0;
            font-size: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        #controls button {
            margin: 8px 8px 8px 0;
            padding: 10px 15px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        #controls button:hover {
            background: #45a049;
        }
        .slider-container {
            margin: 15px 0;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
        }
        .value-display {
            color: #4CAF50;
            font-weight: bold;
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1;
        }
        #legend h3 {
            margin-top: 0;
            font-size: 16px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .legend-color {
            width: 30px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid white;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h2>🌊 3D洪水浸水想定区域</h2>
        <div>
            <button onclick="flyToSaitama()">📍 埼玉中心へ</button>
            <button onclick="flyToRiver()">🏞️ 荒川流域へ</button>
        </div>
        <div class="slider-container">
            <label>立体の高さ: <span id="height-val" class="value-display">5000</span>m</label>
            <input type="range" id="height-slider" min="1000" max="20000" value="5000" step="1000">
        </div>
        <div class="slider-container">
            <label>視点角度: <span id="pitch-val" class="value-display">45</span>°</label>
            <input type="range" id="pitch-slider" min="0" max="60" value="45" step="5">
        </div>
        <div class="slider-container">
            <label>透明度: <span id="opacity-val" class="value-display">80</span>%</label>
            <input type="range" id="opacity-slider" min="0" max="100" value="80" step="10">
        </div>
    </div>

    <div id="legend">
        <h3>浸水深ランク</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #fee5d9;"></div>
            <span>0.5m未満</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #fcae91;"></div>
            <span>0.5～3.0m</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #fb6a4a;"></div>
            <span>3.0～5.0m</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #de2d26;"></div>
            <span>5.0～10.0m</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #a50f15;"></div>
            <span>10.0～20.0m</span>
        </div>
    </div>

    <div id="map"></div>

    <script>
        const {DeckGL, GeoJsonLayer} = deck;

        // PMTiles protocol
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol('pmtiles', protocol.tile);

        // 初期設定
        let elevationScale = 5000;
        let opacity = 0.8;

        // 浸水深に応じた色分け関数
        function getColor(rank) {
            const colors = {
                0: [254, 229, 217],  // 0.5m未満
                1: [252, 174, 145],  // 0.5～3.0m
                2: [251, 106, 74],   // 3.0～5.0m
                3: [222, 45, 38],    // 5.0～10.0m
                4: [165, 15, 21]     // 10.0～20.0m
            };
            return colors[rank] || [200, 200, 200];
        }

        // 浸水深に応じた高さ（立体の高さ）
        function getElevation(rank) {
            const heights = {
                0: 500,
                1: 3000,
                2: 5000,
                3: 10000,
                4: 20000
            };
            return heights[rank] || 1000;
        }

        // PMTilesからGeoJSONを読み込む
        async function loadPMTilesData() {
            try {
                const response = await fetch('hazard_rivers_z9-15_utf8_fixed.pmtiles');
                const arrayBuffer = await response.arrayBuffer();
                const p = new pmtiles.PMTiles(new pmtiles.FetchSource('hazard_rivers_z9-15_utf8_fixed.pmtiles'));

                // ズームレベル10のタイルを取得してGeoJSON化
                // 実際にはPMTilesから全データを取得する必要がありますが、
                // ここでは簡略化のためGeoJSONファイルを使用
                console.log('PMTiles loaded');
            } catch (error) {
                console.error('Error loading PMTiles:', error);
            }
        }

        const deckgl = new DeckGL({
            container: 'map',
            mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            initialViewState: {
                longitude: 139.45,
                latitude: 35.85,
                zoom: 10,
                pitch: 45,
                bearing: 0
            },
            controller: true,
            layers: [
                // 仮のGeoJSONレイヤー（実際のデータは後で追加）
                // PMTilesの代わりにGeoJSONを使用する場合のサンプル
            ]
        });

        // スライダーのイベントリスナー
        document.getElementById('height-slider').addEventListener('input', (e) => {
            elevationScale = parseInt(e.target.value);
            document.getElementById('height-val').textContent = elevationScale;
            updateLayers();
        });

        document.getElementById('pitch-slider').addEventListener('input', (e) => {
            const pitch = parseInt(e.target.value);
            document.getElementById('pitch-val').textContent = pitch;
            deckgl.setProps({
                initialViewState: {
                    ...deckgl.viewState,
                    pitch: pitch
                }
            });
        });

        document.getElementById('opacity-slider').addEventListener('input', (e) => {
            opacity = parseInt(e.target.value) / 100;
            document.getElementById('opacity-val').textContent = e.target.value;
            updateLayers();
        });

        function flyToSaitama() {
            deckgl.setProps({
                initialViewState: {
                    longitude: 139.45,
                    latitude: 35.85,
                    zoom: 10,
                    pitch: 45,
                    bearing: 0,
                    transitionDuration: 2000
                }
            });
        }

        function flyToRiver() {
            deckgl.setProps({
                initialViewState: {
                    longitude: 139.52,
                    latitude: 35.95,
                    zoom: 12,
                    pitch: 50,
                    bearing: -30,
                    transitionDuration: 2000
                }
            });
        }

        function updateLayers() {
            // レイヤー更新のプレースホルダー
            console.log('Layers updated - elevation:', elevationScale, 'opacity:', opacity);
        }

        console.log('Deck.GL initialized');
        console.log('Note: PMTilesデータの読み込みには追加の処理が必要です');
        console.log('代替案: GeoJSONファイルを直接読み込むことをお勧めします');
    </script>
</body>
</html>
