<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>3Dæ´ªæ°´æµ¸æ°´æƒ³å®šåŒºåŸŸãƒãƒƒãƒ— - deck.glç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 350px;
            z-index: 1;
        }
        #controls h2 {
            margin-top: 0;
            font-size: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        #controls button {
            margin: 8px 8px 8px 0;
            padding: 10px 15px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        #controls button:hover {
            background: #45a049;
        }
        .slider-container {
            margin: 15px 0;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
        }
        .value-display {
            color: #4CAF50;
            font-weight: bold;
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1;
        }
        #legend h3 {
            margin-top: 0;
            font-size: 16px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .legend-color {
            width: 30px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid white;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h2>ğŸŒŠ 3Dæ´ªæ°´æµ¸æ°´æƒ³å®šåŒºåŸŸ</h2>
        <div>
            <button onclick="flyToSaitama()">ğŸ“ åŸ¼ç‰ä¸­å¿ƒã¸</button>
            <button onclick="flyToRiver()">ğŸï¸ è’å·æµåŸŸã¸</button>
        </div>
        <div class="slider-container">
            <label>ç«‹ä½“ã®é«˜ã•: <span id="height-val" class="value-display">5000</span>m</label>
            <input type="range" id="height-slider" min="1000" max="20000" value="5000" step="1000">
        </div>
        <div class="slider-container">
            <label>è¦–ç‚¹è§’åº¦: <span id="pitch-val" class="value-display">45</span>Â°</label>
            <input type="range" id="pitch-slider" min="0" max="60" value="45" step="5">
        </div>
        <div class="slider-container">
            <label>é€æ˜åº¦: <span id="opacity-val" class="value-display">80</span>%</label>
            <input type="range" id="opacity-slider" min="0" max="100" value="80" step="10">
        </div>
    </div>

    <div id="legend">
        <h3>æµ¸æ°´æ·±ãƒ©ãƒ³ã‚¯</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #fee5d9;"></div>
            <span>0.5mæœªæº€</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #fcae91;"></div>
            <span>0.5ï½3.0m</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #fb6a4a;"></div>
            <span>3.0ï½5.0m</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #de2d26;"></div>
            <span>5.0ï½10.0m</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #a50f15;"></div>
            <span>10.0ï½20.0m</span>
        </div>
    </div>

    <div id="map"></div>

    <script>
        const {DeckGL, GeoJsonLayer} = deck;

        // PMTiles protocol
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol('pmtiles', protocol.tile);

        // åˆæœŸè¨­å®š
        let elevationScale = 5000;
        let opacity = 0.8;

        // æµ¸æ°´æ·±ã«å¿œã˜ãŸè‰²åˆ†ã‘é–¢æ•°
        function getColor(rank) {
            const colors = {
                0: [254, 229, 217],  // 0.5mæœªæº€
                1: [252, 174, 145],  // 0.5ï½3.0m
                2: [251, 106, 74],   // 3.0ï½5.0m
                3: [222, 45, 38],    // 5.0ï½10.0m
                4: [165, 15, 21]     // 10.0ï½20.0m
            };
            return colors[rank] || [200, 200, 200];
        }

        // æµ¸æ°´æ·±ã«å¿œã˜ãŸé«˜ã•ï¼ˆç«‹ä½“ã®é«˜ã•ï¼‰
        function getElevation(rank) {
            const heights = {
                0: 500,
                1: 3000,
                2: 5000,
                3: 10000,
                4: 20000
            };
            return heights[rank] || 1000;
        }

        // PMTilesã‹ã‚‰GeoJSONã‚’èª­ã¿è¾¼ã‚€
        async function loadPMTilesData() {
            try {
                const response = await fetch('hazard_rivers_z9-15_utf8_fixed.pmtiles');
                const arrayBuffer = await response.arrayBuffer();
                const p = new pmtiles.PMTiles(new pmtiles.FetchSource('hazard_rivers_z9-15_utf8_fixed.pmtiles'));

                // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«10ã®ã‚¿ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦GeoJSONåŒ–
                // å®Ÿéš›ã«ã¯PMTilesã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€
                // ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
                console.log('PMTiles loaded');
            } catch (error) {
                console.error('Error loading PMTiles:', error);
            }
        }

        const deckgl = new DeckGL({
            container: 'map',
            mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            initialViewState: {
                longitude: 139.45,
                latitude: 35.85,
                zoom: 10,
                pitch: 45,
                bearing: 0
            },
            controller: true,
            layers: [
                // ä»®ã®GeoJSONãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã¯å¾Œã§è¿½åŠ ï¼‰
                // PMTilesã®ä»£ã‚ã‚Šã«GeoJSONã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®ã‚µãƒ³ãƒ—ãƒ«
            ]
        });

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('height-slider').addEventListener('input', (e) => {
            elevationScale = parseInt(e.target.value);
            document.getElementById('height-val').textContent = elevationScale;
            updateLayers();
        });

        document.getElementById('pitch-slider').addEventListener('input', (e) => {
            const pitch = parseInt(e.target.value);
            document.getElementById('pitch-val').textContent = pitch;
            deckgl.setProps({
                initialViewState: {
                    ...deckgl.viewState,
                    pitch: pitch
                }
            });
        });

        document.getElementById('opacity-slider').addEventListener('input', (e) => {
            opacity = parseInt(e.target.value) / 100;
            document.getElementById('opacity-val').textContent = e.target.value;
            updateLayers();
        });

        function flyToSaitama() {
            deckgl.setProps({
                initialViewState: {
                    longitude: 139.45,
                    latitude: 35.85,
                    zoom: 10,
                    pitch: 45,
                    bearing: 0,
                    transitionDuration: 2000
                }
            });
        }

        function flyToRiver() {
            deckgl.setProps({
                initialViewState: {
                    longitude: 139.52,
                    latitude: 35.95,
                    zoom: 12,
                    pitch: 50,
                    bearing: -30,
                    transitionDuration: 2000
                }
            });
        }

        function updateLayers() {
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
            console.log('Layers updated - elevation:', elevationScale, 'opacity:', opacity);
        }

        console.log('Deck.GL initialized');
        console.log('Note: PMTilesãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«ã¯è¿½åŠ ã®å‡¦ç†ãŒå¿…è¦ã§ã™');
        console.log('ä»£æ›¿æ¡ˆ: GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥èª­ã¿è¾¼ã‚€ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™');
    </script>
</body>
</html>
